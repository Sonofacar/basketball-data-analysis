---
title: "Modeling NBA Number of Games Played by Players"
author: "Carson Buttars"
date: ""
output: pdf_document
---

```{r setup, include=FALSE}
library(DBI)
library(tidyverse)
library(lubridate)
conn = dbConnect(RSQLite::SQLite(), '../data/bball_db')

birthdays <- dbReadTable(conn, 'player_info') %>%
	as_tibble() %>%
	mutate(Birthday = mdy(Birthday)
	) %>%
	select(Player_ID, Birthday)

season_start <- dbReadTable(conn, 'game_info') %>%
	as_tibble() %>%
	mutate(Date = mdy(Date)) %>%
	group_by(Season) %>%
	summarize(Start_Date = first(Date)) %>%
	select(Season, Start_Date)

team_games <- dbReadTable(conn, 'team_games') %>%
	as_tibble()

player_season_totals <- dbReadTable(conn, 'player_games') %>%
	as_tibble() %>%
	filter(Season <= 2023, Season != 2011, Player_ID != 970) %>%
	inner_join(team_games, by = c('Game_ID' = 'Game_ID',
				      'Team_ID' = 'Team_ID'),
		   suffix = c('', '_team')) %>%
	inner_join(team_games, by = c('Game_ID' = 'Game_ID',
				      'Opponent_ID_team' = 'Team_ID',
				      'Team_ID' = 'Opponent_ID'),
		   suffix = c('', '_opponent')) %>%
	mutate(GmSc = game_score(Points,
				 Twos + Threes,
				 Two_Attempts + Three_Attempts,
				 Freethrows,
				 Freethrow_Attempts,
				 Offensive_Rebounds,
				 Deffensive_Rebounds,
				 Assists,
				 Steals,
				 Blocks,
				 Turnovers,
				 Fouls),
		Poss_team = possessions(Twos_team + Threes_team,
				        Twos_team + Threes_team,
				        Freethrow_Attempts_team,
				        Offensive_Rebounds_team,
				        Deffensive_Rebounds_team,
				        Turnovers_team,
				        Twos_opponent + Threes_opponent,
				        Twos_opponent + Threes_opponent,
				        Freethrow_Attempts_opponent,
				        Offensive_Rebounds_opponent,
				        Deffensive_Rebounds_opponent,
				        Turnovers_opponent),
		Poss_opponent = possessions(Twos_opponent + Threes_opponent,
					    Twos_opponent + Threes_opponent,
					    Freethrow_Attempts_opponent,
					    Offensive_Rebounds_opponent,
					    Deffensive_Rebounds_opponent,
					    Turnovers_opponent,
					    Twos_team + Threes_team,
					    Twos_team + Threes_team,
					    Freethrow_Attempts_team,
					    Offensive_Rebounds_team,
					    Deffensive_Rebounds_team,
					    Turnovers_team),
		Pace_team = pace(MP_team, Poss_team, Poss_opponent),
		Pace_opponent = pace(MP_opponent, Poss_opponent, Poss_team),
		O_Rating = offensive_rating(Points,
					    Seconds / 60,
					    Two_Attempts + Three_Attempts,
					    Twos + Threes,
					    Threes,
					    ThreePA,
					    Freethrow_Attempts,
					    Freethrows,
					    Assists,
					    Offensive_Rebounds,
					    Turnovers,
					    Points_team,
					    MP_team,
					    Twos_team + Threes_team,
					    Two_Attempts_team + Three_Attempts_team,
					    Threes_team,
					    ThreePA_team,
					    Freethrows_team,
					    Freethrow_Attempts_team,
					    Assists_team,
					    Offensive_Rebounds_team,
					    Turnovers_team,
					    REB_opponent,
					    Offensive_Rebounds_opponent),
		D_Rating = defensive_rating(Seconds / 60,
					    Deffensive_Rebounds,
					    Steals,
					    Blocks,
					    Fouls,
					    MP_team,
					    Deffensive_Rebounds_team,
					    Steals_team,
					    Blocks_team,
					    Fouls_team,
					    Poss_team,
					    Points_opponent,
					    MP_opponent,
					    Twos_opponent + Threes_opponent,
					    Two_Attempts_opponent + Three_Attempts_opponent,
					    Freethrows_opponent,
					    Freethrow_Attempts_opponent,
					    Offensive_Rebounds_opponent,
					    Deffensive_Rebounds_opponent,
					    Turnovers_opponent)
		) %>%
	group_by(Player_ID, Season) %>%
	summarize(MP = sum(Seconds) / 60,
		Games = n(),
		FG = sum(Twos) + sum(Threes),
		FGA = sum(Two_Attempts) + sum(Three_Attempts),
		Twos = sum(Twos),
		TwoPA = sum(Two_Attempts),
		Threes = sum(Threes),
		ThreePA = sum(Three_Attempts),
		FT = sum(Freethrows),
		FTA = sum(Freethrow_Attempts),
		O_REB = sum(Offensive_Rebounds),
		D_REB = sum(Deffensive_Rebounds),
		AST = sum(Assists),
		STL = sum(Steals),
		BLK = sum(Blocks),
		TO = sum(Turnovers),
		PF = sum(Fouls),
		Pts = sum(Points),
		Avg_GmSc = mean(GmSc),
		Inj_pct = mean(Injured),
		team_MP = sum(Total_minutes),
		team_FG = sum(Twos_team) + sum(Threes_team),
		team_FGA = sum(Two_Attempts_team) + sum(Three_Attempts_team),
		team_Twos = sum(Twos_team),
		team_TwoPA = sum(Two_Attempts_team),
		team_Threes = sum(Threes_team),
		team_ThreePA = sum(Three_Attempts_team),
		team_FT = sum(Freethrows_team),
		team_FTA = sum(Freethrow_Attempts_team),
		team_O_REB = sum(Offensive_Rebounds_team),
		team_D_REB = sum(Deffensive_Rebounds_team),
		team_AST = sum(Assists_team),
		team_STL = sum(Steals_team),
		team_BLK = sum(Blocks_team),
		team_TO = sum(Turnovers_team),
		team_PF = sum(Fouls_team),
		team_Pts = sum(Points_team),
		opp_MP = sum(Total_minutes_opponent),
		opp_FG = sum(Twos_opponent) + sum(Threes_opponent),
		opp_FGA = sum(Two_Attempts_opponent) + sum(Three_Attempts_opponent),
		opp_Twos = sum(Twos_opponent),
		opp_TwoPA = sum(Two_Attempts_opponent),
		opp_Threes = sum(Threes_opponent),
		opp_ThreePA = sum(Three_Attempts_opponent),
		opp_FT = sum(Freethrows_opponent),
		opp_FTA = sum(Freethrow_Attempts_opponent),
		opp_O_REB = sum(Offensive_Rebounds_opponent),
		opp_D_REB = sum(Deffensive_Rebounds_opponent),
		opp_AST = sum(Assists_opponent),
		opp_STL = sum(Steals_opponent),
		opp_BLK = sum(Blocks_opponent),
		opp_TO = sum(Turnovers_opponent),
		opp_PF = sum(Fouls_opponent),
		opp_Pts = sum(Points_opponent),
	) %>%
	mutate(Usage = usage(MP, FGA, FTA, TO, team_MP, team_FGA, team_FTA, team_TO),
		O_Rating = offensive_rating(Pts, MP, FGA, FGM, Threes, ThreePA, FTA,
					    FTM, AST, O_REB, TOV, team_Pts, team_MP,
					    team_FGM, team_FGA, team_Threes, team_ThreePA,
					    team_FTM, team_FTA, team_AST, team_O_REB,
					    team_TOV, opp_REB, opp_O_REB),
		D_Rating = defensive_rating(MP, D_REB, STL, BLK, PF, team_MP,
					    team_D_REB, team_STL, team_BLK, team_PF,
					    team_Poss, opp_Pts, opp_MP, opp_FGM,
					    opp_FGA, opp_FTM, opp_FTA, opp_O_REB,
					    opp_D_REB, opp_TOV),
		O_W_shares = ,
		D_W_shares = ,
		PIE = ,
	) %>%
	inner_join(birthdays, by = c('Player_ID' = 'Player_ID')) %>%
	inner_join(season_start, by = c('Season' = 'Season')) %>%
	mutate(Age = floor(interval(Birthday, Start_Date) / years(1)))
```

---
# The response variable: games per season
# Explanatory variables I want to grab:
# - Age (at beginning of season)
# - usage
# - Last year's touches
# - Last year's team pace
# - Last year's minutes per game
# - Last 2 years' minutes per game
# - Last 3 years' games played %
# - Last 5 years' games played %
# - Career proportion of games injured
# - Offensive Rating
# - Defensive Rating
# - Offensive Win Shares
# - Defensive Win Shares
# - Player Impact Estimate
# - Average Game Score
---

```{r data_cleanup, include=FALSE}

```
